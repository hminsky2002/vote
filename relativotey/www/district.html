
<!doctype html>
<html>
  <head>
    <!-- Mabpox GL -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.17.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.17.0/mapbox-gl.css' rel='stylesheet'>

    <!-- Mapbox.js (fallback) -->
    <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />

    <!-- GeoViewport -->
    <script src='geoviewport.js'></script>



    <script>
      var results;


      /**
       * Build and execute request to look up voter info for provided address.
       * @param {string} address Address for which to fetch voter info.
       * @param {function(Object)} callback Function which takes the
       *     response object as a parameter.
       */
       function lookup(address, callback) {
       /**
         * Election ID for which to fetch voter info.
         * @type {number}
         */
        var electionId = 2000;
 
        /**
         * Request object for given parameters.
         * @type {gapi.client.HttpRequest}
         */
        var req = gapi.client.request({


            'path' : '/civicinfo/v2/representatives',
            'params' : {'address': address}
        });
       req.execute(callback);
      }

      /**
       * Render results in the DOM.
       * @param {Object} response Response object returned by the API.
       * @param {Object} rawResponse Raw response from the API.
       */
      function renderResults(response, rawResponse) {
        var el = document.getElementById('results');
        if (!response || response.error) {
          el.appendChild(document.createTextNode(
              'Error while trying to fetch polling place'));
          return;
        }
	  console.log(response);
	  console.log(rawResponse);
	  
	  results = response;
	  var district = null;
	  for (var key in response.divisions) {
	      var data = response[key];
	      m = key.match(/\/cd:(\d+)$/);
	      if (m != null) {
		  district = m[1];
		  break;
	      }
	  }

	  el.innerHTML = district;
	  

	  var divs = response.divisions;

	  var accessToken = 'pk.eyJ1IjoiYWFyb25kZW5uaXMiLCJhIjoiem5LLURoYyJ9.T3tswGTI5ve8_wE-a02cMw';
	  var styleURL = 'mapbox://styles/aarondennis/cioafmhk70047adnmt3gz2kd0';
	  var mapId = 'aarondennis.cd-114-2015'; // used by the click handler only
	  var continentalView = function(w,h) { return geoViewport.viewport([-128.8, 23.6, -65.4, 50.2], [w, h]); }
	  var continental = continentalView(window.innerWidth/2, window.innerHeight/2);

	    mapboxgl.accessToken = accessToken;
	  var map = new mapboxgl.Map({
	      container: 'map',
	      style: styleURL,
	      center: continental.center,
	      zoom: continental.zoom
	  });


	      // Retrieve the JSON styling object for the map
    var baseStyle = map.getStyle()

    // Add zoom and rotation controls to the map
    map.addControl(new mapboxgl.Navigation({ position: 'bottom-left' }));

    // Disable using touch gestures for map rotation
    map.touchZoomRotate.disableRotation();

    // Given a state postal abbreviation and a US Census district number, focus the map on that area
    function focusMap(stateAbbr, districtCode) {
      //** INTERACTIVE MENU
      // Set the interactive menu to focus on the state and district code, if provided
      $('#state').val(stateAbbr);
      $('#district').empty();
      possibleDistricts[stateAbbr].map(function(d) {
        $('#district')
          .append($("<option></option>")
            .attr('value', d).text(d));
      });
      if (districtCode) $('#district').val(districtCode);

      // For each district color layer in the map, apply some filters...
      for (var i = 1; i <= 5; i++) {

        // The filter that filters based on color is the one we want to preserve
        // If there are already multiple filters applied, it will be the last one
        var exisitingFilter = map.getFilter('districts_' + i);
        if (exisitingFilter[0] === 'all') {
          exisitingFilter = exisitingFilter[exisitingFilter.length - 1];
        }

        // Create a fresh filter to be applied
        var filter = ['all'];

        // Add filters for the focus state and district number
        if (stateAbbr) filter.push(['==', 'state', stateAbbr]);
        if (districtCode) filter.push(['==', 'number', districtCode]);

        // Add the existing color filter
        var layerFilter = filter.concat([exisitingFilter]);

        // Set new layer filter for each district layer in the map
        map.setFilter('districts_' + i, layerFilter);
        map.setFilter('districts_' + i + '_boundary', layerFilter);
        map.setFilter('districts_' + i + '_label', layerFilter);

      }

      // Create a generic filter for the focus state and district number that does not include color filtering
      var boundaryFilter = ['all'];
      if (stateAbbr) boundaryFilter.push(['==', 'state', stateAbbr]);
      if (districtCode) boundaryFilter.push(['==', 'number', districtCode]);

      // Apply the generic filter to the boundary lines
      map.setFilter('districts_boundary_line', boundaryFilter);

      // Determine current window height and width and whether the bbox should focus on a single district
      var height = window.innerHeight,
          width = window.innerWidth,
          districtAbbr = districtCode ? districtCode : '';

      // Determine the best center and zoom level for the new map focus and then go there
      var view = geoViewport.viewport(bboxes[stateAbbr + districtAbbr], [width/2, height/2]);
      map.jumpTo(view);



      }

    function checkHash() {
      // If a URL hash is found...
      if(window.location.hash) {

        // Grab the URL hash
        var hash = window.location.hash;

        // Split up the hash string into its components
        var hashData = hash.substring(1).split('&').map(function(d) { return d.split('=') });

        // Determine state or district based on the hash data
        var state, district;
        hashData.map(function(d) {
          if (d[0] === 'state') state = d[1];
          if (d[0] === 'district') district = d[1];
        })

        // If a state or state and district were found in the URL hash, focus the map to this location
        if (state || (state && district)) focusMap(state, district);

      } else {
        // If there is no URL hash...
        // And if its not the first time the page is loading...
        if (!initial) {

          // Reset the map style to its original style object and jump back to the continental view
          map.setStyle(baseStyle);
          map.jumpTo(continentalView(window.innerWidth/2, window.innerHeight/2));

          //** INTERACTIVE MENU
          // Empty the list of districts because no state is selected
          $('#district').empty();
        }
      }
    }


      /**
       * Initialize the API client and make a request.
       */
      function load() {
        gapi.client.setApiKey('AIzaSyCzPmoqSuBu_wgzwuRauq0V0LQYtY919Ik');
        lookup('67 Clyde st, Newton MA', renderResults);
      }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=load"></script>
  </head>
  <body>
    <div id="results"></div>
    <div id='map'></div>
  </body>
</html>


  
